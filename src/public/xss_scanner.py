import requests
import os
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException


def check_xss(url):
    # Set up Chrome options for Selenium
    chrome_options = Options()
    driver = webdriver.Chrome(executable_path=os.environ.get("CHROMEDRIVER_PATH"), options=chrome_options)
    chrome_options.add_argument("--headless") 
    chrome_options.add_argument("--disable-gpu") 
    chrome_options.add_argument('--no-sandbox') 
    driver = webdriver.Chrome(executable_path=os.environ.get("CHROMEDRIVER_PATH"), chrome_options=chrome_options)
  

    # Define your payloads
    payloads = ["<script>alert('XSS')</script>", "..."]
    
    # Check each payload
    for payload in payloads:
        try:
            driver.get(url + payload)
            WebDriverWait(driver, 3).until(EC.alert_is_present(),
            'Timed out waiting for PA creation ' +'confirmation popup to appear.')

            alert = driver.switch_to.alert
            alert_text = alert.text
            alert.accept()
            print("alert accepted")
            return True, alert_text  # XSS vulnerability found
        except TimeoutException:
            print("no alert")
            # No alert means no XSS detected (or it might not be reflected XSS)
            continue
        finally:
            driver.quit()
    
    return False, "No reflected XSS vulnerability found with the test payloads."
